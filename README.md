# Image Mask Curation Utilities (imutils)

A simple toolset for semi-automated generation and interactive curation of image segmentation masks, built around Cellpose.

---

## Dependencies

This project requires the following Python packages. 

```
cellpose
matplotlib
numpy
opencv-python
scikit-image
scikit-learn
scipy
tifffile
torch
torchvision
```


## How to Run the Curation Script

The main example script `mask_curation.py` automates the process of generating initial masks with Cellpose and launching an interactive GUI for refinement.

### Usage

Run the script from your terminal and provide the paths to your data and desired output location.

```bash
python mask_curation.py \
  --raw_data_dir "/path/to/your/raw/images" \
  --output_dir "/path/to/your/output/folder" \
  --crop_size 300
```

### Command-Line Arguments

* `--raw_data_dir` (**required**): The folder containing your source images (`.tif`, `.png`, etc.).
* `--output_dir` (**required**): The folder where all outputs will be saved.
* `--crop_size` (optional): The size of the square center crop. Defaults to `300`.

### Workflow

1.  The script will first check the output directory for any previously generated or curated masks. If found, it will ask if you want to **load them** for curation instead of generating new ones.
2.  It then processes each image by creating a center crop.
3.  Next, it either generates initial masks with **Cellpose** or loads existing ones.
4.  Finally, it launches the **interactive curation GUI** for you to review, edit, and approve the masks for each image.

### Output Directory Structure

The script will organize all generated files inside your specified `--output_dir` as follows:

```
/path/to/your/output/folder/
├── crops/              # Stores the cropped versions of your raw images
├── cpose_masks/        # Stores the initial masks generated by Cellpose
└── curated_masks/      # Stores the final, edited masks you save from the GUI
```

## Interactive Editor Controls

The editor has two primary modes: **Mask Annotation** and **Point Labeling**. The controls change depending on the active mode.

---

### General Controls (Available in all modes)

* `n`: **Go to the next image.**
* `b`: **Go to the previous image.**
* `+` or `=`: **Zoom in.**
* `-`: **Zoom out.**
* Arrow Keys (`up`, `down`, `left`, `right`): **Pan the image** when it's zoomed in.
* `q` or *closing the window*: **Quit the application.**

---

### Mask Annotation Mode

This is the default mode for creating and editing segmentation masks.

#### Viewing and Basic Editing

* `Right-Click` on a mask: **Delete the selected mask.**
* `x`: **Clear all masks** from the current image.
* `v`: **Cycle the mask display style** (options: rings, solid color, off).
* `f`: **Toggle Free-draw Mode** to outline a new mask.
* `m`: **Toggle Merge Mode** to combine multiple masks.
* `l`: **Toggle Labeling Mode** to classify existing masks.

#### Free-draw Mode (toggled by `f`)

* `Left-Click and Drag`: **Draw the polygon outline** of a new mask.
* `Release Left-Click`: **Finalize and create the new mask.**

#### Merge Mode (toggled by `m`)

* `Left-Click` on multiple masks: **Select masks to be merged.** Selected masks will be highlighted.
* `Enter`: **Finalize the merge**, combining all selected masks into the first one selected.

#### Labeling Mode (toggled by `l`)

* `Left-Click` on a mask: **Cycle through its classification labels** (e.g., unlabelled, alive, dead, junk).
* `v`: **Cycle the label color source** (options: your labels, model predictions, off).
* `u`: **Update the backend classifier** with the current set of labels.

---

### Point Labeling Mode

This mode is for placing simple coordinate labels on the image.

* `Left-Click`: **Place an 'alive' point.**
* `Right-Click`: **Place a 'dead' point.**
* `Click` on an existing point: **Delete that point.**
